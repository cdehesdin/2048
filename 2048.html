<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Clément DEHESDIN</title>
    <link rel="stylesheet" href="./src/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://lalten.github.io/lmweb/style/latinmodern-sans.css" type="text/css" charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <header>
        <div class="home">
            <a href="."><i class="fa-solid fa-house"></i></a>
        </div>
        <ul>
            <li><a href="./morpion.html">Morpion</a></li>
            <li><a href="./reversi.html">Reversi</a></li>
            <li><a href="./2048.html" class="active">2048</a></li>
            <li><a href="./sudoku.html">Sudoku</a></li>
        </ul>
    </header>
    <main class="game">
        <div class="game_2048">
            <div class="title">
                <h1>2048</h1>
                <div>
                    <a class="retry"><i class="fa-solid fa-rotate-right"></i></a>
                    <div id="score">0</div>
                </div>
            </div>
            <div class="table">
                <div class="game-message">
                    <span class="hidden">Jeu terminé !</span>
                    <a class="retry">Commencez une partie</a>
                </div>
                <div>
                    <div id="cell-1"></div>
                    <div id="cell-2"></div>
                    <div id="cell-3"></div>
                    <div id="cell-4"></div>
                </div>
                <div>
                    <div id="cell-5"></div>
                    <div id="cell-6"></div>
                    <div id="cell-7"></div>
                    <div id="cell-8"></div>
                </div>
                <div>
                    <div id="cell-9"></div>
                    <div id="cell-10"></div>
                    <div id="cell-11"></div>
                    <div id="cell-12"></div>
                </div>
                <div>
                    <div id="cell-13"></div>
                    <div id="cell-14"></div>
                    <div id="cell-15"></div>
                    <div id="cell-16"></div>
                </div>
            </table>
        </div>
        <footer>© 2025-26 • Clément DEHESDIN</footer>
    </main>
</body>
<script>
const randomInt = (max) => Math.floor(Math.random() * max)

const clearGame = (game) => {
    for (let x=0; x<game.grid.length; x++) {
        for (let y=0; y<game.grid.length; y++) {
            const cell = document.querySelector(`#cell-${game.grid.length*x+y+1}`)
            cell.innerHTML = null
            cell.className = null
        }
    }
}

const displayGame = (game) => {
    document.querySelector(`#score`).innerHTML = game.score
    for (let x=0; x<game.grid.length; x++) {
        for (let y=0; y<game.grid.length; y++) {
            if (game.grid[x][y] !== 0) {
                const cell = document.querySelector(`#cell-${game.grid.length*x+y+1}`)
                cell.innerHTML = game.grid[x][y]
                cell.classList.add(`nb-${game.grid[x][y]}`)
            }
        }
    }
}

class Game_2048 {
    grid = [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]]
    score = 0

    constructor () {
        for (let nb=0; nb<2; nb++) {
            let x = randomInt(4), y = randomInt(4)
            while (this.grid[x][y] !== 0) {
                x = randomInt(4)
                y = randomInt(4)
            }
            this.grid[x][y] = this.twoOrFour()
        }
    }

    clone () {
        const newGame = new Game_2048();
        newGame.grid = this.grid.map((arr) => arr.slice())
        newGame.score = this.score
        return newGame
    }

    twoOrFour () {
        if (randomInt(10) === 9)
            return 4
        else
            return 2
    }

    left () {
        for (let nb=0; nb<2; nb++) {
            // Mouvement
            for (let x=0; x < this.grid.length; x++) {
                for (let y=1; y < this.grid.length; y++) {
                    if (this.grid[x][y] !== 0) {
                        let gap = 1
                        while (y-gap >= 0 && y-gap <= this.grid.length-1 && this.grid[x][y-gap] === 0) {
                            this.grid[x][y-gap] = this.grid[x][y-gap+1]
                            this.grid[x][y-gap+1] = 0
                            gap++
                        }
                    }
                }
            }

            // Fusion
            if (nb === 0) {
                for (let x=0; x < this.grid.length; x++) {
                    for (let y=1; y < this.grid.length; y++) {
                        if (this.grid[x][y] !== 0) {
                            if (this.grid[x][y-1] === this.grid[x][y]) {
                                this.score += this.grid[x][y]*2
                                this.grid[x][y-1] = this.grid[x][y]*2
                                this.grid[x][y] = 0
                            }
                        }
                    }
                }
            }
        }
    }

    right () {
        for (let nb=0; nb<2; nb++) {
            // Mouvement
            for (let x=0; x<this.grid.length; x++) {
                for (let y=this.grid.length-2; y>-1; y--) {
                    if (this.grid[x][y] !== 0) {
                        let gap = 1
                        while (0 <= y+gap && y+gap <= this.grid.length-1 && this.grid[x][y+gap] === 0) {
                            this.grid[x][y+gap] = this.grid[x][y+gap-1]
                            this.grid[x][y+gap-1] = 0
                            gap++
                        }
                    }
                }
            }

            // Fusion
            if (nb == 0) {
                for (let x=0; x<this.grid.length; x++) {
                    for (let y=this.grid.length-2; y>-1; y--) {
                        if (this.grid[x][y] !== 0) {
                            if (this.grid[x][y+1] === this.grid[x][y]) {
                                this.grid[x][y+1] = this.grid[x][y]*2
                                this.score += this.grid[x][y]*2
                                this.grid[x][y] = 0
                            }
                        }
                    }
                }
            }
        }
    }

    up () {
        for (let nb=0; nb<2; nb++) {
            // Mouvement
            for (let x=1; x<this.grid.length; x++) {
                for (let y=0; y<this.grid.length; y++) {
                    if (this.grid[x][y] !== 0) {
                        let gap = 1
                        while (0 <= x-gap && x-gap <= this.grid.length-1 && this.grid[x-gap][y] === 0) {
                            this.grid[x-gap][y] = this.grid[x-gap+1][y]
                            this.grid[x-gap+1][y] = 0
                            gap++
                        }
                    }
                }
            }
            // Fusion
            if (nb == 0) {
                for (let x=1; x<this.grid.length; x++) {
                    for (let y=0; y<this.grid.length; y++) {
                        if (this.grid[x][y] !== 0) {
                            if (this.grid[x-1][y] === this.grid[x][y]) {
                                this.grid[x-1][y] = this.grid[x][y]*2
                                this.score += this.grid[x][y]*2
                                this.grid[x][y] = 0
                            }
                        }
                    }
                }
            }
        }
    }

    down () {
        for (let nb=0; nb<2; nb++) {
            // Mouvement
            for (let x=this.grid.length-2; x>-1; x--) {
                for (let y=0; y<this.grid.length; y++) {
                    if (this.grid[x][y] !== 0) {
                        let gap = 1
                        while (0 <= x+gap && x+gap <= this.grid.length-1 && this.grid[x+gap][y] === 0) {
                            this.grid[x+gap][y] = this.grid[x+gap-1][y]
                            this.grid[x+gap-1][y] = 0
                            gap++
                        }
                    }
                }
            }

            // Fusion
            if (nb == 0) {
                for (let x=this.grid.length-2; x>-1; x--) {
                    for (let y=0; y<this.grid.length; y++) {
                        if (this.grid[x][y] !== 0) {
                            if (this.grid[x+1][y] === this.grid[x][y]) {
                                this.grid[x+1][y] = this.grid[x][y]*2
                                this.score += this.grid[x][y]*2
                                this.grid[x][y] = 0
                            }
                        }
                    }
                }
            }
        }
    }

    movement (axes) {
        switch (axes) {
            case 'd': case 0:
                this.down()
                break
            case 'u': case 1:
                this.up()
                break
            case 'l': case 2:
                this.left()
                break
            case 'r': case 3:
                this.right()
                break
        }
    }

    isValid (axes) {
        const newGame = this.clone()
        newGame.movement(axes)
        for (let x=0; x<this.grid.length; x++) {
            for (let y=0; y<this.grid.length; y++) {
                if (newGame.grid[x][y] != this.grid[x][y])
                    return true
            }
        }
        return false
    }

    isFinish () {
        for (let axes=0; axes<this.grid.length; axes++) {
            if (this.isValid(axes))
                return false
        }
        return true
    }
}

const gameActive = (axes) => {
    if (game.isValid(axes)) {
        game.movement(axes)
                
        let x = randomInt(4), y = randomInt(4)
        while (game.grid[x][y] !== 0) {
            x = randomInt(4)
            y = randomInt(4)
        }
        game.grid[x][y] = game.twoOrFour()
    }

    document.querySelector(`#score`).innerHTML = game.score
    for (let x=0; x<game.grid.length; x++) {
        for (let y=0; y<game.grid.length; y++) {
            const cell = document.querySelector(`#cell-${game.grid.length*x+y+1}`)
            cell.innerHTML = null
            cell.classList = []
            if (game.grid[x][y] !== 0) {
                cell.innerHTML = game.grid[x][y]
                cell.classList.add(`nb-${game.grid[x][y]}`)
            }
        }
    }

    if (game.isFinish()) {
        document.querySelector(`.game-message`).classList.remove("hidden")
        document.querySelector(`.game-message a.retry`).innerHTML = "Recommencez une partie"
        document.querySelector(`.game-message span`).classList = []
    }
}

let game = undefined

console.log(document.querySelectorAll(`.retry`))
document.querySelectorAll(`.retry`).forEach((element) => element.addEventListener("click", () => {
    document.querySelector(`.game-message`).classList.add("hidden")
    game = new Game_2048()
    clearGame(game)
    displayGame(game)
}))

// Pour le mouvement avec les flèches
document.addEventListener("keydown", (e) => {
    if (typeof game !== 'undefined' && !game.isFinish()) {
        switch (e.key) {
            case "ArrowUp":
                gameActive('u')
                break
            case "ArrowDown":
                gameActive('d')
                break
            case "ArrowRight":
                gameActive('r')
                break
            case "ArrowLeft":
                gameActive('l')
                break
        }
    }
})

// Pour le mouvement avec les doigts
let startX = 0;
let startY = 0;

document.querySelectorAll(`.game`).addEventListener("touchstart", function (e) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
});

document.addEventListener("touchend", function (e) {
    if (typeof game !== 'undefined' && !game.isFinish()) {
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;

        const deltaX = endX - startX;
        const deltaY = endY - startY;

        const seuil = 30;

        if (Math.abs(deltaX) > Math.abs(deltaY)) {
            if (Math.abs(deltaX) > seuil) {
                if (deltaX > 0)
                    gameActive('r')
                else
                    gameActive('l')
            }
        } else {
            if (Math.abs(deltaY) > seuil) {
                if (deltaY > 0)
                    gameActive('d')
                else
                    gameActive('u')
            }
        }
    }
    startX = 0
    startY = 0
});

</script>
</html>